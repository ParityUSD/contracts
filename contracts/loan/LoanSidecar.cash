pragma cashscript ^0.12.0;

// LoanSidecar carrying the loanTokenId by holding an NFT

// The NFT indentifier isn't used anywhere, instead its tokenCategory is used to keep the loanTokenId
/*  --- State Immutable NFT ---
  byte identifier == 0x01
*/

contract LoanTokenSidecar() {
  function attach() {
    // Authenticate loan at InputIndex - 1
    int loanInputIndex = this.activeInputIndex - 1;
    require(tx.inputs[this.activeInputIndex].outpointTransactionHash == tx.inputs[loanInputIndex].outpointTransactionHash);
    require(tx.inputs[this.activeInputIndex].outpointIndex == tx.inputs[loanInputIndex].outpointIndex + 1);

    // Check if loan is recreated in outputs at loanInputIndex
    bool isLoanRecreated = tx.outputs[loanInputIndex].tokenCategory == tx.inputs[loanInputIndex].tokenCategory;
    if(isLoanRecreated){
      // Recreate loanSidecar at corrresponding outputIndex
      require(tx.outputs[this.activeInputIndex].lockingBytecode == tx.inputs[this.activeInputIndex].lockingBytecode);
      require(tx.outputs[this.activeInputIndex].nftCommitment == tx.inputs[this.activeInputIndex].nftCommitment);
      require(tx.outputs[this.activeInputIndex].tokenCategory == tx.inputs[this.activeInputIndex].tokenCategory);
      require(tx.outputs[this.activeInputIndex].value == 1000);
    }
  }
}